// Game controller script attached to the background game object (which has colliders for each egg area)

using UnityEngine;
using System.Collections;

public class Matching : MonoBehaviour
{
	public GameObject egg1Prefab, egg2Prefab, chickPrefab1, chickPrefab2, chickPrefab3, restartButton;
	public GameObject[] eggs = new GameObject[6];
	public GUIText timer, bestDisplay;
	public Collider2D[] colliders = new Collider2D[6];

	private GameObject[] chickClones = new GameObject[6];
	private GameObject[] chicksRevealed = new GameObject[2];
	private GameObject[] eggsDestroyed = new GameObject[2];
	private Collider2D[] collidersDisabled = new Collider2D[2];
	private int timePassed, startTime, reveals = 0, matches = 0;
	private static int bestTime = 100;
	private bool paused = false;

	void Start()
	{
		startTime = (int)Time.time;
		restartButton.SetActive(false);
		restartButton.layer = 2;
		if (bestTime != 100) {bestDisplay.text = "Best time: " + bestTime;}
		eggs[0] = Instantiate(egg1Prefab, eggs[0].transform.position, transform.rotation) as GameObject;
		eggs[1] = Instantiate(egg2Prefab, eggs[1].transform.position, transform.rotation) as GameObject;
		eggs[2] = Instantiate(egg1Prefab, eggs[2].transform.position, transform.rotation) as GameObject;
		eggs[3] = Instantiate(egg2Prefab, eggs[3].transform.position, transform.rotation) as GameObject;
		eggs[4] = Instantiate(egg1Prefab, eggs[4].transform.position, transform.rotation) as GameObject;
		eggs[5] = Instantiate(egg2Prefab, eggs[5].transform.position, transform.rotation) as GameObject;

		randomize();
	}

	void OnMouseDown()
	{
		// Get click position to hatch appropriate egg
		Vector3 mouseWorldPoint = Camera.main.ScreenToWorldPoint(Input.mousePosition);
		if (mouseWorldPoint.x < -3)
		{
			// Dealing with eggs[0]
			colliders[0].enabled = false;
			chickClones[0].SetActive(true);
			chicksRevealed[reveals] = chickClones[0];
			eggsDestroyed[reveals] = eggs[0];
			collidersDisabled[reveals] = colliders[0];
			eggs[0].SetActive(false);
		}
		else if (mouseWorldPoint.y < 0 && mouseWorldPoint.x < 0)
		{
			// Dealing with eggs[3]
			colliders[3].enabled = false;
			chickClones[3].SetActive(true);
			chicksRevealed[reveals] = chickClones[3];
			eggsDestroyed[reveals] = eggs[3];
			collidersDisabled[reveals] = colliders[3];
			eggs[3].SetActive(false);
		}
		else if (mouseWorldPoint.x < 0)
		{
			// Dealing with eggs[1]
			colliders[1].enabled = false;
			chickClones[1].SetActive(true);
			chicksRevealed[reveals] = chickClones[1];
			eggsDestroyed[reveals] = eggs[1];
			collidersDisabled[reveals] = colliders[1];
			eggs[1].SetActive(false);
		}
		else if (mouseWorldPoint.x < 2 && mouseWorldPoint.y < 0)
		{
			// Dealing with eggs[4]
			colliders[4].enabled = false;
			chickClones[4].SetActive(true);
			chicksRevealed[reveals] = chickClones[4];
			eggsDestroyed[reveals] = eggs[4];
			collidersDisabled[reveals] = colliders[4];
			eggs[4].SetActive(false);
		}
		else if (mouseWorldPoint.y > 0)
		{
			// Dealing with eggs[2]
			colliders[2].enabled = false;
			chickClones[2].SetActive(true);
			chicksRevealed[reveals] = chickClones[2];
			eggsDestroyed[reveals] = eggs[2];
			collidersDisabled[reveals] = colliders[2];
			eggs[2].SetActive(false);
		}
		else
		{
			// Dealing with eggs[5]
			colliders[5].enabled = false;
			chickClones[5].SetActive(true);
			chicksRevealed[reveals] = chickClones[5];
			eggsDestroyed[reveals] = eggs[5];
			collidersDisabled[reveals] = colliders[5];
			eggs[5].SetActive(false);
		}
		reveals++;
		StartCoroutine("checkMatch");
	}

	void OnGUI()
	{
		if (paused == false)
		{
			timePassed = (int)Time.time - startTime;
			timePassed %= 60;
			timer.text = timePassed.ToString();
		}
	}

	IEnumerator checkMatch()
	{
		// Set layer to ignore raycast (clicks) while match checking happens
		this.gameObject.layer = 2;
		if (reveals == 2)
		{
			if (chicksRevealed[0].GetComponent<SpriteRenderer>().color == 
				chicksRevealed[1].GetComponent<SpriteRenderer>().color)
			{
				//match!
				matches++;
			}
			else
			{
				//no match, wait a few seconds to let player memorize then replace chicks with eggs
				yield return new WaitForSeconds(1.5f);
				chicksRevealed[0].SetActive(false);
				chicksRevealed[1].SetActive(false);
				eggsDestroyed[0].SetActive(true);
				eggsDestroyed[1].SetActive(true);
				collidersDisabled[0].enabled = true;
				collidersDisabled[1].enabled = true;
			}
			reveals = 0;	
		}
		// Game won
		if (matches == 3)
		{
			restartButton.SetActive(true);
			restartButton.layer = 0;
			if (timePassed < bestTime)
			{
				bestDisplay.text = "Best time: " + timePassed.ToString();
				bestTime = timePassed;
			}
			paused = true;
		}
		else {this.gameObject.layer = 0;}	
		//yield return new WaitForSeconds(1.0f);
	}

	void randomize()
	{
		System.Random rand = new System.Random();
		// Unfinished, need to make sure each color is assigned exactly 2 times, colors are currently
		// hardcoded below
		int whichColor, count1 = 0, count2 = 0, count3 = 0, i = 0;
		bool iterationIsValid;
		while (count1 != 2 || count2 != 2 || count3 != 2)
		{
			//print(count1 + "\n" + count2 + "\n" + count3);
			whichColor = rand.Next(1,4);
			iterationIsValid = false;
			if (whichColor == 1 && count1 < 2) 
			{
				iterationIsValid = true;
				chickClones[i] = Instantiate(chickPrefab1, eggs[i].transform.position, transform.rotation) as GameObject;
				count1++;
			}
			else if (whichColor == 2 && count2 < 2)
			{
				iterationIsValid = true;
				chickClones[i] = Instantiate(chickPrefab2, eggs[i].transform.position, transform.rotation) as GameObject;
				count2++;
			}
			else if (whichColor == 3 && count3 < 2)
			{
				iterationIsValid = true;
				chickClones[i] = Instantiate(chickPrefab3, eggs[i].transform.position, transform.rotation) as GameObject;
				count3++;
			}
			if (iterationIsValid)
			{
				chickClones[i].SetActive(false);
				i++;
			}
		}
	}
}